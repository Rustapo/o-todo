const api_url='api/api.php',log=console.log,current_year=(new Date).getFullYear();let side_menu,messages,article_ids=[];function getParameterByName(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,'\\$&');const n=new RegExp('[?&]'+e+'(=([^&#]*)|&|#|$)').exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g,' ')):'':null}function openModal(e,t){if(side_menu.style.width=0,document.getElementById(e).style.display='block',!t)for(let e=0;e<messages.length;e++)messages[e].innerHTML=''}function handleNoteActions(){const e=document.getElementsByTagName('article');for(let t=0;t<e.length;t++){let n;e[t].onclick=(n=>{openModal('edit-note'),document.getElementById('edit-note-title').value=e[t].getAttribute('title'),document.getElementById('edit-note-note').innerText=e[t].getAttribute('note'),document.getElementById('edit-note-note').value=e[t].getAttribute('note'),document.getElementById('edit-note-due-date').value=e[t].getAttribute('due'),document.getElementById('edit-note-importance').value=e[t].getAttribute('importance'),document.getElementById('edit-note-id').value=e[t].getAttribute('note-id'),document.getElementById('edit-note-done').onclick=(()=>{noteDone(e[t])}),document.getElementById('edit-note-update').onclick=(()=>{updateNote(e[t])})}),e[t].ontouchstart=(e=>{n=e.touches[0].clientY}),e[t].ontouchmove=(o=>{n-o.touches[0].clientY>125&&noteDone(e[t])})}}function showHint(e,t,n){let o=list.childNodes;for(let d=0;d<o.length;d++)if('ARTICLE'==o[d].nodeName){if('none'!=o[d].style.display){document.getElementById('hint').style.display='none';break}}else document.getElementById('hint').style.display='block',e&&t&&(document.getElementById('hint-title').innerHTML=e,document.getElementById('hint-body').innerHTML=t,document.getElementById('hint-title').style.color=n?'red':'initial')}function noteDone(e){if(e){for(let t=0;t<article_ids.length;t++)if(e.getAttribute('note-id')==article_ids[t]){let n=article_ids[t];log('Removing note with id '+n),fetch(api_url,{method:'delete',headers:{'Content-type':'application/x-www-form-urlencoded; charset=UTF-8'},credentials:'include',body:'note-id='+n}).then(json).then(function(t){t.error?t.error&&(log('Failed to remove note'),showStatus('Failed to remove note.','danger'),setMessages(t.message)):(fetchNotes(),log('Success. Removed note.'),showStatus('Removed note.','ok'),e.style.opacity='0',document.getElementById('edit-note').style.display='none')}).catch(function(e){console.log('Request failed',e),setMessages('Failed to remove note from database.'),showStatus('Failed to remove note.','danger'),showHint('Error',e,!0)}),article_ids.splice(t,1)}setTimeout(()=>{e.style.display='none',showHint()},300)}}function updateNote(e){if(e){let t=e.getAttribute('note-id'),n='update-note=1&updated-note-title='+document.getElementById('edit-note-title').value+'&updated-note-body='+document.getElementById('edit-note-note').value+'&updated-note-due-date='+document.getElementById('edit-note-due-date').value+'&updated-note-importance='+document.getElementById('edit-note-importance').value+'&note-id='+t;fetch(api_url,{method:'put',headers:{'Content-type':'application/x-www-form-urlencoded; charset=UTF-8'},credentials:'include',body:n}).then(json).then(function(e){e.error?e.error&&(log('Failed to update note'),setMessages(e.message),showStatus('Failed to update note.','danger')):(fetchNotes(),log('Success. Updated note.'),showStatus('Updated note.','ok'),document.getElementById('edit-note').style.display='none')}).catch(function(e){log('Request failed',e),setMessages('Failed to update note.'),showStatus('Failed to update note.','danger'),showHint('Error',e,!0)})}}function setMessages(e){for(let t=0;t<messages.length;t++)messages[t].innerHTML=e}function showStatus(e,t){const n=document.getElementById('timed-status'),o=document.getElementById('timed-status-bar');document.getElementById('timed-status-text');let d;switch(t){case'ok':d='#4CAF50';break;case'warn':d='#f0ad4e';break;case'danger':d='#d9534f';break;default:d='#0275d8'}document.getElementById('timed-status-text').innerHTML=e,n.style.backgroundColor=d,n.style.bottom='0',o.style.transition='width 4s',o.style.transitionTimingFunction='linear',o.style.width='0',o.style.zIndex='51',setTimeout(()=>{n.style.bottom='-40px',o.style.transition='none',o.style.width='100%',o.style.zIndex='-1'},4e3)}function json(e){return 200==e.status?e.json():(log(e.status+' '+e.statusText),{HTTP_STATUS:e.status,HTTP_STATUS_TEXT:e.statusText,title:'Error',message:'Server responded with HTTP satus:<br>'+e.status+' '+e.statusText,error:!0})}function fetchNotes(){let e=document.getElementsByTagName('article');for(let t=e.length-1;t>=0;t--)e[t].remove();fetch(api_url+'?action=list',{method:'get',headers:{'Content-type':'application/x-www-form-urlencoded; charset=UTF-8'},credentials:'include'}).then(json).then(function(e){if(!e.error&&e.notes){article_ids=[];for(let t=0;t<e.notes.length;t++){let n=document.createElement('article'),o=document.createElement('h3'),d=document.createElement('p'),s=document.createElement('span');o.innerHTML=e.notes[t].title,d.innerHTML=e.notes[t].body,s.innerHTML=e.notes[t].due,n.appendChild(o),n.appendChild(d),n.appendChild(s),n.setAttribute('title',e.notes[t].title),n.setAttribute('note',e.notes[t].body),n.setAttribute('due',e.notes[t].due),n.setAttribute('note-id',e.notes[t].id),n.setAttribute('created',e.notes[t].created),n.setAttribute('importance',e.notes[t].importance),new Date(e.notes[t].due).getTime()-(new Date).getTime()<0&&(s.style.color='#cc0018'),list.appendChild(n),article_ids.push(e.notes[t].id),handleNoteActions()}showHint('Add a note','Click the <i class="fa fa-plus" aria-hidden="true"></i> icon at the top of the screen or via the sidemenu.')}else e.error&&(showHint(e.title,e.message,!0),showStatus('Failed to refresh notes.','danger'))}).catch(function(e){log('Request failed',e),showHint('Error',e,!0),showStatus('Failed to refresh notes.','danger')})}window.onload=(()=>{document.getElementsByClassName('current-year');side_menu=document.getElementById('side-menu'),messages=document.getElementsByClassName('message');const e=document.getElementById('list'),t=document.getElementsByTagName('body');let n,o;document.getElementById('menu-button').onclick=(()=>{side_menu.style.width='300px'}),document.getElementById('main').onclick=(()=>{side_menu.style.width=0}),e.onwheel=(t=>{side_menu.style.width=0,t.deltaY,e.scrollBy(t.deltaY,0)}),e.onscroll=(()=>{side_menu.style.width=0}),side_menu.ontouchstart=(e=>{n=e.touches[0].clientX}),side_menu.ontouchmove=(e=>{n-e.touches[0].clientX>50&&(side_menu.style.width=0)}),t[0].ontouchstart=(e=>{o=e.touches[0].clientX}),t[0].ontouchmove=(e=>{o<=50&&e.touches[0].clientX-o>50&&(side_menu.style.width='300px')});const d=document.getElementsByClassName('close-modal');for(let e=0;e<d.length;e++)d[e].onclick=(t=>{d[e].parentElement.parentElement.style.display='none'});const s=document.getElementsByClassName('add-note-button');for(let e=0;e<s.length;e++)s[e].onclick=(()=>{openModal('add-note')});document.getElementById('profile-button').onclick=(()=>{openModal('profile')}),document.getElementsByTagName('figure')[0].onclick=(()=>{openModal('profile')}),document.getElementById('logout-button').onclick=(()=>{window.location='login.php'});const l=document.getElementById('api-key');l.onclick=(()=>{l.select(),document.execCommand('copy')}),document.getElementById('refresh').onclick=(()=>{fetchNotes(),side_menu.style.width=0}),document.getElementById('new-note-submit').onclick=(()=>{document.getElementById('new-note-create-date').valueAsDate=new Date;let e='new-note=1&new-note-title='+document.getElementById('new-note-title').value+'&new-note-body='+document.getElementById('new-note-body').value+'&new-note-due-date='+document.getElementById('new-note-due-date').value+'&new-note-importance='+document.getElementById('new-note-importance').value+'&new-note-create-date='+document.getElementById('new-note-create-date').value;fetch(api_url,{method:'post',headers:{'Content-type':'application/x-www-form-urlencoded; charset=UTF-8'},credentials:'include',body:e}).then(json).then(function(e){e.error?e.error&&(setMessages(e.message),showStatus('Failed to add note.','danger')):(fetchNotes(),document.getElementById('add-note').style.display='none',document.getElementById('new-note-title').value='',document.getElementById('new-note-body').value='',document.getElementById('new-note-due-date').value='',document.getElementById('new-note-importance').value='0',setMessages(''),showStatus('Added note.','ok'),log('Success. Added note to list.'))}).catch(function(e){log('Request failed',e),setMessages('Failed to add note to database.'),showHint('Error',e,!0),showStatus('Failed to add note.','danger')})}),getParameterByName('modal')&&(getParameterByName('message')?(setMessages(getParameterByName('message')),openModal(getParameterByName('modal'),!0)):openModal(getParameterByName('modal'))),fetchNotes()}),'serviceWorker'in navigator?navigator.serviceWorker.register('service-worker.js').then(()=>{log('Service-worker registerd')}):console.error('Service-workers not supported.');